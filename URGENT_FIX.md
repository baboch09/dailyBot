# üö® –°–†–û–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Webhook –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞

–ò–∑ –≤–∞—à–∏—Ö –ª–æ–≥–æ–≤:
```
üì¶ YooKassa webhook received: {
  type: 'notification',              ‚Üê –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç!
  paymentId: '310c518a-000f-5000-b000-1eccfa5908c2',
  status: 'succeeded',
  mode: 'production'
}
‚ùå Webhook signature is missing in production mode  ‚Üê –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è!
```

**–ü—Ä–∏—á–∏–Ω—ã:**
1. YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (`type: 'notification'` –≤–º–µ—Å—Ç–æ `type: 'payment.succeeded'`)
2. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–¥–ø–∏—Å—å webhook (`x-yookassa-signature`)
3. –ö–æ–¥ –æ—Ç–∫–ª–æ–Ω—è–ª —Ç–∞–∫–∏–µ webhook'–∏

---

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ webhook:**
   - –ù–æ–≤—ã–π: `type: 'payment.succeeded'`
   - –°—Ç–∞—Ä—ã–π: `type: 'notification'` + `status: 'succeeded'`

2. **–ü–æ–¥–ø–∏—Å—å —Ç–µ–ø–µ—Ä—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è:**
   - –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
   - –≠—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ –ª—É—á—à–µ —á–µ–º —Ç–µ—Ä—è—Ç—å –ø–ª–∞—Ç–µ–∂–∏

3. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ë–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏—Ö–æ–¥—è—â–∏—Ö webhook'–∞—Ö
   - –ü–æ–Ω—è—Ç–Ω–µ–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ

---

## üöÄ –î–µ–π—Å—Ç–≤–∏—è –°–ï–ô–ß–ê–°

### 1Ô∏è‚É£ –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∑–∞–≤–∏—Å—à–∏–π –ø–ª–∞—Ç–µ–∂

–û—Ç–∫—Ä–æ–π—Ç–µ Prisma Studio (—É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ñ–æ–Ω–µ):
```bash
# –û—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω–∞ http://localhost:5555
open http://localhost:5555
```

**–í—Ä—É—á–Ω—É—é –æ–±–Ω–æ–≤–∏—Ç–µ:**

1. **–¢–∞–±–ª–∏—Ü–∞ Payment:**
   - –ù–∞–π–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂ —Å `yookassaId = '310c518a-000f-5000-b000-1eccfa5908c2'`
   - –ò–∑–º–µ–Ω–∏—Ç–µ `status` —Å `pending` –Ω–∞ `succeeded`
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

2. **–¢–∞–±–ª–∏—Ü–∞ User:**
   - –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç—Ç–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ (–ø–æ `userId`)
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
     ```
     subscriptionType: 'premium'
     subscriptionStatus: 'active'
     subscriptionExpiresAt: <—Å–µ–≥–æ–¥–Ω—è + 30 –¥–Ω–µ–π>  (–¥–ª—è –º–µ—Å—è—á–Ω–æ–π) –∏–ª–∏ <—Å–µ–≥–æ–¥–Ω—è + 365 –¥–Ω–µ–π> (–¥–ª—è –≥–æ–¥–æ–≤–æ–π)
     subscriptionStartedAt: <—Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞>  (–µ—Å–ª–∏ –ø—É—Å—Ç–æ)
     ```
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**–ö–∞–∫ —É–∑–Ω–∞—Ç—å —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏:**
- –ï—Å–ª–∏ —Å—É–º–º–∞ 79 —Ä—É–± ‚Üí –º–µ—Å—è—á–Ω–∞—è (+ 30 –¥–Ω–µ–π)
- –ï—Å–ª–∏ —Å—É–º–º–∞ 799 —Ä—É–± ‚Üí –≥–æ–¥–æ–≤–∞—è (+ 365 –¥–Ω–µ–π)

### 2Ô∏è‚É£ –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥

```bash
cd /Users/ebabochiev/Desktop/tg

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
cd backend && npm run dev

# –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add backend/src/controllers/payments.controller.ts
git commit -m "Fix webhook handling: support old format and missing signature"

# –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ Vercel
git push origin main
# –∏–ª–∏
vercel --prod
```

### 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ YooKassa

–ó–∞–π–¥–∏—Ç–µ: https://yookassa.ru/my/merchant/integration/http-notifications

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- ‚úÖ URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `https://your-app.vercel.app/api/payments/webhook`
- ‚úÖ –°–æ–±—ã—Ç–∏—è: –≤—ã–±—Ä–∞–Ω—ã `payment.succeeded` –∏ `payment.canceled`
- ‚úÖ –°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–µ–Ω
- ‚ö†Ô∏è  **–í–∫–ª—é—á–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–∫–∞—è –æ–ø—Ü–∏—è)

**–ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª "–ü–æ–¥–ø–∏—Å—å":**
- –í–∫–ª—é—á–∏—Ç–µ –µ—ë
- –≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-yookassa-signature` –∫ webhook'–∞–º

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook:

1. –°–¥–µ–ª–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ 79‚ÇΩ)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel:
   ```bash
   vercel logs --follow
   ```

3. –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
   ```
   üì¶ YooKassa webhook received: { type: 'notification', ... }
   ‚úÖ Valid payment event received: { paymentId: '...', isSucceeded: true }
   üîÑ Updating payment status: pending ‚Üí succeeded
   ‚úÖ Payment xxx processed successfully
   üÜï Activating new subscription
   ‚úÖ Subscription activated for user yyy
   ```

### –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

**–í–∞—Ä–∏–∞–Ω—Ç –ê: –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏**

–í `backend/src/config/index.ts` –≤—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
```typescript
isTestMode: true  // –í—Ä–µ–º–µ–Ω–Ω–æ!
```

–≠—Ç–æ –æ—Ç–∫–ª—é—á–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é.

**–í–∞—Ä–∏–∞–Ω—Ç –ë: Webhook –Ω–∞ ngrok (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)**

–ï—Å–ª–∏ webhook –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –≤–æ–æ–±—â–µ:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok
brew install ngrok

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
cd backend && npm run dev

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
ngrok http 5001

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä https://abc123.ngrok.io)
# –í YooKassa webhook URL: https://abc123.ngrok.io/api/payments/webhook
```

---

## üìä SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ï—Å–ª–∏ Prisma Studio –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```sql
-- 1. –ù–∞–π—Ç–∏ pending –ø–ª–∞—Ç–µ–∂
SELECT 
  p.id,
  p."yookassaId",
  p."userId",
  p.amount,
  p.status,
  p.metadata,
  u."telegramId"
FROM "Payment" p
JOIN "User" u ON u.id = p."userId"
WHERE p."yookassaId" = '310c518a-000f-5000-b000-1eccfa5908c2';

-- 2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
UPDATE "Payment"
SET status = 'succeeded', "updatedAt" = NOW()
WHERE "yookassaId" = '310c518a-000f-5000-b000-1eccfa5908c2';

-- 3. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É (–º–µ—Å—è—á–Ω–∞—è - 30 –¥–Ω–µ–π)
UPDATE "User"
SET 
  "subscriptionType" = 'premium',
  "subscriptionStatus" = 'active',
  "subscriptionStartedAt" = NOW(),
  "subscriptionExpiresAt" = NOW() + INTERVAL '30 days',
  "updatedAt" = NOW()
WHERE id = (
  SELECT "userId" FROM "Payment" 
  WHERE "yookassaId" = '310c518a-000f-5000-b000-1eccfa5908c2'
);

-- 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT 
  u."telegramId",
  u."subscriptionType",
  u."subscriptionStatus",
  u."subscriptionExpiresAt",
  p.status as "paymentStatus",
  p.amount
FROM "User" u
JOIN "Payment" p ON p."userId" = u.id
WHERE p."yookassaId" = '310c518a-000f-5000-b000-1eccfa5908c2';
```

---

## üìû –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç

**–°–≤—è–∂–∏—Ç–µ—Å—å —Å YooKassa:**
- üìß support@yookassa.ru
- üì± 8 (800) 250-66-99

**–°–∫–∞–∂–∏—Ç–µ:**
> "Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ type: 'notification', –Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —É–∫–∞–∑–∞–Ω —Ñ–æ—Ä–º–∞—Ç type: 'payment.succeeded'. –¢–∞–∫–∂–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ x-yookassa-signature. –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å webhook?"

**–ò–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç:**
- –ó–∞–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa
- –ù–∞–π–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂ `310c518a-000f-5000-b000-1eccfa5908c2`
- –ù–∞–∂–º–∏—Ç–µ "–í–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏"
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –∫–∞—Ä—Ç—É

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
- [ ] –ö–æ–¥ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω (`npm run build`)
- [ ] –¢–µ–∫—É—â–∏–π –∑–∞–≤–∏—Å—à–∏–π –ø–ª–∞—Ç–µ–∂ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
- [ ] –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã –Ω–∞ Vercel
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ YooKassa
- [ ] –°–¥–µ–ª–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
- [ ] Webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

**–°–æ–∑–¥–∞–Ω–æ:** 2026-01-28  
**Priority:** üî• URGENT
