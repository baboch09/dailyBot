# üí≥ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Æ–ö–∞—Å–æ–π (YooKassa)

## ‚úÖ –ß—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –º–æ–¥–µ–ª—å `User`
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å `Payment` –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

### 2. API Endpoints

#### –ü–æ–¥–ø–∏—Å–∫–∞ (—Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏):
- `GET /api/subscription/status` - –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `GET /api/subscription/plans` - –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤
- `POST /api/subscription/create-payment` - –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
- `GET /api/subscription/payment/:paymentId/status` - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞

#### –ü–ª–∞—Ç–µ–∂–∏:
- `POST /api/payments/webhook` - Webhook –æ—Ç –Æ–ö–∞—Å—Å—ã

### 3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤–ª–µ–Ω—ã –≤ Vercel:
- `YUKASSA_SHOP_ID=1255129`
- `YUKASSA_SECRET_KEY=test_MN536RM4vAW14xV3teGaeeJJWNwLtGC6mK4dR2BB8Yg`
- `YUKASSA_TEST_MODE=true`
- `PAYMENT_SUCCESS_URL` - URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- `PAYMENT_FAIL_URL` - URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –æ–ø–ª–∞—Ç—ã

### 4. Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –Æ–ö–∞—Å—Å–µ
- URL: `https://your-backend.vercel.app/api/payments/webhook`

---

## üìã –¢–∞—Ä–∏—Ñ—ã

- **–ú–µ—Å—è—Ü**: 99 ‚ÇΩ (30 –¥–Ω–µ–π)
- **–ì–æ–¥**: 990 ‚ÇΩ (365 –¥–Ω–µ–π)

---

## üîí –õ–∏–º–∏—Ç—ã Free –ø–æ–¥–ø–∏—Å–∫–∏

- –ú–∞–∫—Å–∏–º—É–º **3 –ø—Ä–∏–≤—ã—á–∫–∏** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ `middleware/subscription.ts`)
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã, –Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏:
```bash
GET /api/subscription/status
Headers: x-telegram-id: <your_telegram_id>
```

### 2. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤:
```bash
GET /api/subscription/plans
Headers: x-telegram-id: <your_telegram_id>
```

### 3. –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂:
```bash
POST /api/subscription/create-payment
Headers: x-telegram-id: <your_telegram_id>
Body: { "planId": "month" }
```

–û—Ç–≤–µ—Ç:
```json
{
  "paymentId": "...",
  "yookassaId": "...",
  "amount": 99,
  "confirmationUrl": "https://yoomoney.ru/checkout/payments/...",
  "status": "pending"
}
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞:
```bash
GET /api/subscription/payment/:paymentId/status
Headers: x-telegram-id: <your_telegram_id>
```

---

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–ø–ª–∞—Ç–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ `POST /api/subscription/create-payment`
2. –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç–µ–∂ –≤ –Æ–ö–∞—Å—Å–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `confirmationUrl`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∏ –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
4. –Æ–ö–∞—Å—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –Ω–∞ `/api/payments/webhook`
5. –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ `PAYMENT_SUCCESS_URL`

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏)
- ‚úÖ –í—Å–µ endpoints —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `x-telegram-id`
- ‚úÖ –ü–ª–∞—Ç–µ–∂–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
2. ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
3. ‚úÖ Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –Æ–ö–∞—Å—Å–µ
4. ‚è≥ –°–æ–∑–¥–∞—Ç—å UI –¥–ª—è –æ–ø–ª–∞—Ç—ã –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
5. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –Ω—É–∂–Ω—ã–µ endpoints
6. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–ø–ª–∞—Ç—ã

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook:
- –õ–æ–≥–∏ Vercel Functions ‚Üí `/api/payments/webhook`
- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: `üì¶ YooKassa webhook received`

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `GET /api/subscription/payment/:paymentId/status`
- –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–ö–∞—Å—Å—ã

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:
- **–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞**: `5555555555554444`
- **–û—Ç–∫–ª–æ–Ω—ë–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞**: `5555555555554477`
- CVV: –ª—é–±—ã–µ 3 —Ü–∏—Ñ—Ä—ã
- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: –ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Æ–ö–∞—Å—Å—ã

- API: https://yookassa.ru/developers/api
- Webhook: https://yookassa.ru/developers/payments/payment-notifications
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing