# üöÄ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ YooKassa

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–±—ä—è—Å–Ω—è–µ—Ç, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ —Å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ YooKassa –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã-–ø–ª–∞—Ç–µ–∂–µ–π)
2. [–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤](#–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ-—Ä–µ–∂–∏–º–æ–≤)
3. [–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∫—à–Ω –∫–ª—é—á–µ–π](#–ø–æ–ª—É—á–µ–Ω–∏–µ-–ø—Ä–æ–¥–∞–∫—à–Ω-–∫–ª—é—á–µ–π)
4. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-webhook)
5. [–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏](#–ø—Ä–æ–≤–µ—Ä–∫–∞-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
6. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
7. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
8. [Troubleshooting](#troubleshooting)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Frontend (React)                   ‚îÇ
‚îÇ  ‚Ä¢ –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–∞—Ä–∏—Ñ—ã                                ‚îÇ
‚îÇ  ‚Ä¢ –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞                      ‚îÇ
‚îÇ  ‚Ä¢ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ POST /api/subscription/create-payment
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Backend API (Express)                   ‚îÇ
‚îÇ  ‚Ä¢ –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ YooKassa API                ‚îÇ
‚îÇ  ‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–ª–∞—Ç–µ–∂ –≤ –ë–î                            ‚îÇ
‚îÇ  ‚Ä¢ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç confirmationUrl                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ API Request
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              YooKassa API                           ‚îÇ
‚îÇ  ‚Ä¢ –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å–µ—Å—Å–∏—é                         ‚îÇ
‚îÇ  ‚Ä¢ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂                              ‚îÇ
‚îÇ  ‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚îÇ Webhook: POST /api/payments/webhook
                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Webhook Handler (Backend)                  ‚îÇ
‚îÇ  ‚Ä¢ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å webhook                       ‚îÇ
‚îÇ  ‚Ä¢ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤ –ë–î                    ‚îÇ
‚îÇ  ‚Ä¢ –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞:

1. **Test Mode (`YUKASSA_MODE=test`)**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `test_`)
   - –ú–æ–∂–Ω–æ –æ–ø–ª–∞—á–∏–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏
   - –î–µ–Ω—å–≥–∏ –Ω–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è
   - –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook

2. **Production Mode (`YUKASSA_MODE=production`)**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç live –∫–ª—é—á–∏
   - –†–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Å –∫–∞—Ä—Ç
   - –î–µ–Ω—å–≥–∏ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å –∫–∞—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
   - **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞** –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook

---

## –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤

### –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º (Test)

```bash
# backend/.env
YUKASSA_SHOP_ID=1255129
YUKASSA_SECRET_KEY=test_MN536RM4vAW14xV3teGaeeJJWNwLtGC6mK4dR2BB8Yg
YUKASSA_MODE=test
```

### –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Production

**–®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç–µ –ø—Ä–æ–¥–∞–∫—à–Ω –∫–ª—é—á–∏** (—Å–º. —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª)

**–®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**

–õ–æ–∫–∞–ª—å–Ω–æ (`backend/.env`):
```bash
YUKASSA_SHOP_ID=1255129
YUKASSA_SECRET_KEY=live_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
YUKASSA_MODE=production
```

–ù–∞ Vercel:
```bash
# –ß–µ—Ä–µ–∑ Vercel Dashboard –∏–ª–∏ CLI
vercel env add YUKASSA_SECRET_KEY
# –í–≤–µ–¥–∏—Ç–µ: live_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

vercel env add YUKASSA_MODE
# –í–≤–µ–¥–∏—Ç–µ: production
```

**–®–∞–≥ 3: Redeploy –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

```bash
git add .
git commit -m "Switch to production YooKassa mode"
git push origin main

# –ò–ª–∏ —á–µ—Ä–µ–∑ CLI
vercel --prod
```

**–í–ê–ñ–ù–û:** –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- ‚úÖ –ß—Ç–æ –≤ production —Ä–µ–∂–∏–º–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è test –∫–ª—é—á–∏
- ‚úÖ –§–æ—Ä–º–∞—Ç –∫–ª—é—á–µ–π

–ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∏ –≤—ã–≤–µ–¥–µ—Ç –æ—à–∏–±–∫—É.

---

## –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∫—à–Ω –∫–ª—é—á–µ–π

### 1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa

https://yookassa.ru/my

### 2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è"

```
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
```

### 3. –ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á–∏

**Shop ID:**
- –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–î–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞"
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤ (test –∏ production)

**Secret Key (Production):**
- –í —Ä–∞–∑–¥–µ–ª–µ "API –∫–ª—é—á–∏" —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª—é—á
- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø: **"–ë–æ–µ–≤–æ–π –∫–ª—é—á"** (live)
- –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á **—Å—Ä–∞–∑—É** - –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- –ö–ª—é—á –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `live_`

**Secret Key (Test):**
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ –≤—ã–±–µ—Ä–∏—Ç–µ **"–¢–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á"**
- –ö–ª—é—á –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `test_`

### 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ

‚ö†Ô∏è **–í–ê–ñ–ù–û:**
- –ù–ï –∫–æ–º–º–∏—Ç—å—Ç–µ –∫–ª—é—á–∏ –≤ git
- –ù–ï –ø—É–±–ª–∏–∫—É–π—Ç–µ –∫–ª—é—á–∏ –≤ public —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö
- –•—Ä–∞–Ω–∏—Ç–µ –∫–ª—é—á–∏ –≤ password manager
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ environment variables

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook

Webhook –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–µ–π.

### 1. –ü–æ–ª—É—á–∏—Ç–µ URL –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
Production: https://your-app.vercel.app
Webhook URL: https://your-app.vercel.app/api/payments/webhook
```

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –≤ YooKassa

–í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa:

```
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- **URL:** `https://your-app.vercel.app/api/payments/webhook`
- **–°–æ–±—ã—Ç–∏—è:**
  - ‚úÖ `payment.succeeded` - –ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
  - ‚úÖ `payment.canceled` - –ø–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω
- **–ú–µ—Ç–æ–¥:** POST
- **–§–æ—Ä–º–∞—Ç:** JSON

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook

YooKassa –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ—Å—Ç–æ–≤—ã–π webhook. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
# Vercel CLI
vercel logs --follow

# –ò–ª–∏ –≤ Vercel Dashboard
https://vercel.com/your-project/deployments/[id]/logs
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
üì¶ YooKassa webhook received: payment.succeeded
‚úÖ Webhook signature validated successfully
‚úÖ Payment xxx status updated to succeeded
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`backend/src/config/index.ts`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:

```
‚úÖ –ù–∞–ª–∏—á–∏–µ YUKASSA_SHOP_ID
‚úÖ –ù–∞–ª–∏—á–∏–µ YUKASSA_SECRET_KEY
‚úÖ –ù–∞–ª–∏—á–∏–µ DATABASE_URL
‚úÖ –í production: Secret Key –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å test_
‚úÖ –§–æ—Ä–º–∞—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

### –õ–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

**Test mode:**
```
üß™ Test mode: Using test YooKassa credentials
üìã Application configuration loaded:
   Environment: development
   YooKassa mode: test üß™
   Shop ID: 1255129
   Secret Key: test_MN536...
```

**Production mode:**
```
üîí Production mode: Using live YooKassa credentials
üìã Application configuration loaded:
   Environment: production
   YooKassa mode: production üîí
   Shop ID: 1255129
   Secret Key: live_XXXXX...
üöÄ PRODUCTION MODE ENABLED - Using live payments!
   Make sure webhook URL is configured in YooKassa dashboard
   Webhook URL should be: https://your-domain.com/api/payments/webhook
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

**1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

–õ–æ–∫–∞–ª—å–Ω–æ:
```bash
cd backend
cat .env | grep YUKASSA
```

–ù–∞ Vercel:
```bash
vercel env ls
```

**2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:**

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
npm run dev

# Vercel
vercel logs --follow
```

**3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health endpoint:**

```bash
curl https://your-app.vercel.app/api/health
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Test Mode (–¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã)

**–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
```
–ö–∞—Ä—Ç–∞: 5555 5555 5555 4444
–°—Ä–æ–∫: –ª—é–±–æ–π –±—É–¥—É—â–∏–π
CVC: –ª—é–±–æ–π
3D Secure: –ª—é–±–æ–π –∫–æ–¥
```

**–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
```
–ö–∞—Ä—Ç–∞: 5555 5555 5555 5599
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤:**
```
–ö–∞—Ä—Ç–∞: 5555 5555 5555 5278
```

### Production Mode (–†–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –í production —Ä–µ–∂–∏–º–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **—Ä–µ–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É**!

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂:**
1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É (79‚ÇΩ)
2. –û–ø–ª–∞—Ç–∏—Ç–µ —Å–≤–æ–µ–π –∫–∞—Ä—Ç–æ–π
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∞—Å—å
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–µ–Ω—å–≥–∏ —Å–ø–∏—Å–∞–ª–∏—Å—å —Å –∫–∞—Ä—Ç—ã
5. **–°–¥–µ–ª–∞–π—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç** —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook

**1. –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (—Å ngrok):**

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ ngrok
ngrok http 5001

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok URL –¥–ª—è webhook
# https://xxxx-xx-xx-xx-xx.ngrok-free.app/api/payments/webhook
```

**2. Production:**

Webhook –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ YooKassa Dashboard

**3. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook –≤—Ä—É—á–Ω—É—é:**

```bash
# –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π webhook
curl -X POST https://your-app.vercel.app/api/payments/webhook \
  -H "Content-Type: application/json" \
  -H "x-yookassa-signature: test_signature" \
  -d '{
    "type": "payment.succeeded",
    "object": {
      "id": "test_payment_id",
      "status": "succeeded"
    }
  }'
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –ø–ª–∞—Ç–µ–∂–µ–π

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
üìù Creating payment: userId=xxx, planId=month, amount=79

// Webhook –ø–æ–ª—É—á–µ–Ω
üì¶ YooKassa webhook received: payment.succeeded xxx

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
‚úÖ Webhook signature validated successfully
// –∏–ª–∏
‚ùå Invalid webhook signature - possible attack

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
üîÑ Updating payment status: xxx pending -> succeeded

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
üÜï Activating new subscription
‚úÖ Subscription activated for user xxx
   Plan: month
   Expires at: 2026-02-28T10:00:00.000Z
```

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

**–í –ª–æ–≥–∞—Ö –∏—â–∏—Ç–µ:**
```
‚ùå Error processing webhook
‚ùå SECURITY ERROR: Cannot use test credentials in production
‚ùå Webhook signature is missing in production mode
‚ùå Invalid webhook signature
```

### –ú–µ—Ç—Ä–∏–∫–∏

–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π (%)
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook
- –û—à–∏–±–∫–∏ webhook

**TODO:** –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å:
- Sentry (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫)
- DataDog / New Relic (–º–µ—Ç—Ä–∏–∫–∏)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Cannot use test credentials in production mode"

**–ü—Ä–∏—á–∏–Ω–∞:** –í `YUKASSA_MODE=production`, –Ω–æ `YUKASSA_SECRET_KEY` –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `test_`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –û–±–Ω–æ–≤–∏—Ç–µ secret key –Ω–∞ live
vercel env add YUKASSA_SECRET_KEY
# –í–≤–µ–¥–∏—Ç–µ live –∫–ª—é—á

# Redeploy
vercel --prod
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Webhook signature is missing"

**–ü—Ä–∏—á–∏–Ω–∞:** YooKassa –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å—å –≤ webhook

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ YooKassa Dashboard
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
3. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É YooKassa

### –ü—Ä–æ–±–ª–µ–º–∞: "Invalid webhook signature"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ webhook

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é YooKassa –ø–æ —Ñ–æ—Ä–º–∞—Ç—É –ø–æ–¥–ø–∏—Å–∏
2. –û–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `validateWebhookSignature()` –≤ `utils/yookassa.ts`
3. –°—Ä–∞–≤–Ω–∏—Ç–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ YooKassa

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// backend/src/utils/yookassa.ts
// SHA-256 hash: event_type&object_id&object_status&secret_key
const signatureString = `${eventType}&${objectId}&${objectStatus}&${secretKey}`
const calculatedSignature = crypto.createHash('sha256').update(signatureString).digest('hex')
```

–ï—Å–ª–∏ YooKassa –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é:
```typescript
validateWebhookSignatureHMAC(requestBody, signature, secretKey)
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∞—Å—å"

**–ü—Ä–∏—á–∏–Ω–∞:** Webhook –Ω–µ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Å –æ—à–∏–±–∫–æ–π

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤—Ä—É—á–Ω—É—é:
   ```bash
   # –í backend
   curl https://your-app.vercel.app/api/subscription/check-latest-payment \
     -H "x-telegram-id: YOUR_TELEGRAM_ID"
   ```
3. –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ succeeded, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–∫—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤ `payments.controller.ts`
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ metadata –ø–ª–∞—Ç–µ–∂–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å planId)

### –ü—Ä–æ–±–ª–µ–º–∞: "CORS –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ"

**–ü—Ä–∏—á–∏–Ω–∞:** YooKassa —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ URL, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –≤ —Å–ø–∏—Å–∫–µ ALLOWED_ORIGINS

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω –≤ ALLOWED_ORIGINS
vercel env add ALLOWED_ORIGINS
# –í–≤–µ–¥–∏—Ç–µ: https://your-app.vercel.app,https://yoomoney.ru
```

---

## –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ Production

### –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

- [ ] –ü–æ–ª—É—á–µ–Ω—ã live –∫–ª—é—á–∏ YooKassa
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω—ã environment variables –Ω–∞ Vercel
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω webhook URL –≤ YooKassa Dashboard
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å production mode)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂
- [ ] –°–¥–µ–ª–∞–Ω –≤–æ–∑–≤—Ä–∞—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω webhook (–ª–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫
- [ ] –°–æ–∑–¥–∞–Ω –ø–ª–∞–Ω —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

---

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è YooKassa API](https://yookassa.ru/developers/api)
- [Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](https://yookassa.ru/developers/using-api/webhooks)
- [–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ](https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing)
- [FAQ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](https://yookassa.ru/developers/support)
- [–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa](https://yookassa.ru/my)

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel: `vercel logs --follow`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å webhook –≤ YooKassa Dashboard
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: `vercel env ls`
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É YooKassa: https://yookassa.ru/developers/support

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2026-01-28  
**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ
