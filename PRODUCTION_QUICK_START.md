# üöÄ –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏

## TL;DR - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

‚úÖ **–£–¥–∞–ª–µ–Ω –≤–µ—Å—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥** (streak 5 –º–∏–Ω—É—Ç = –¥–µ–Ω—å)  
‚úÖ **–°–æ–∑–¥–∞–Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π  
‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ webhook –ø–æ–¥–ø–∏—Å–∏** –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏  
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤** test/production  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è  

---

## –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤

### –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: Test (—Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏)

```bash
# backend/.env
YUKASSA_MODE=test
YUKASSA_SECRET_KEY=test_MN536RM4vAW14xV3teGaeeJJWNwLtGC6mK4dR2BB8Yg
```

### –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Production (—Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)

**1. –ü–æ–ª—É—á–∏—Ç–µ live –∫–ª—é—á–∏ YooKassa:**
- –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://yookassa.ru/my
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí API –∫–ª—é—á–∏
- –°–æ–∑–¥–∞–π—Ç–µ **–ë–æ–µ–≤–æ–π –∫–ª—é—á** (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `live_`)

**2. –û–±–Ω–æ–≤–∏—Ç–µ .env —Ñ–∞–π–ª:**

```bash
# backend/.env
YUKASSA_MODE=production
YUKASSA_SECRET_KEY=live_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

**3. –ù–∞ Vercel:**

```bash
vercel env add YUKASSA_MODE
# –í–≤–µ–¥–∏—Ç–µ: production

vercel env add YUKASSA_SECRET_KEY
# –í–≤–µ–¥–∏—Ç–µ: live_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

vercel --prod
```

**4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –≤ YooKassa:**
- URL: `https://your-app.vercel.app/api/payments/webhook`
- –°–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

**–ì–æ—Ç–æ–≤–æ!** üéâ

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —É–≤–∏–¥–∏—Ç–µ:

**Test mode:**
```
üß™ Test mode: Using test YooKassa credentials
```

**Production mode:**
```
üîí Production mode: Using live YooKassa credentials
üöÄ PRODUCTION MODE ENABLED - Using live payments!
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫:

–ï—Å–ª–∏ –∑–∞–±—É–¥–µ—Ç–µ –ø–æ–º–µ–Ω—è—Ç—å –∫–ª—é—á:
```
‚ùå SECURITY ERROR: Cannot use test credentials in production mode!
Please set YUKASSA_SECRET_KEY to your live secret key.
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ **–Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è** —Å test –∫–ª—é—á–∞–º–∏ –≤ production —Ä–µ–∂–∏–º–µ! ‚úÖ

---

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `backend/src/config/index.ts`

- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è test –∫–ª—é—á–µ–π –≤ production

### 2. –£–¥–∞–ª–µ–Ω –≤–µ—Å—å —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥

**–ë—ã–ª–æ:**
- `getCurrentPeriod()` - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫ 5-–º–∏–Ω—É—Ç–Ω—ã–º –ø–µ—Ä–∏–æ–¥–∞–º
- `TEST_MODE` –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ –≤—Å–µ–º—É –∫–æ–¥—É
- –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ streak —Å —Ç–µ—Å—Ç–æ–≤—ã–º —Ä–µ–∂–∏–º–æ–º

**–°—Ç–∞–ª–æ:**
- –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–Ω—è–º–∏
- –ß–∏—Å—Ç—ã–π –∫–æ–¥ –±–µ–∑ —É—Å–ª–æ–≤–∏–π –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
- Streak —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–Ω—è–º–∏

### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å webhook

**–ë—ã–ª–æ:**
```typescript
// TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ–¥–ø–∏—Å–∏
console.warn('‚ö†Ô∏è Webhook signature validation not fully implemented')
return true
```

**–°—Ç–∞–ª–æ:**
```typescript
// –ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è SHA-256 –ø–æ–¥–ø–∏—Å–∏
const signatureString = `${eventType}&${objectId}&${objectStatus}&${secretKey}`
const calculatedSignature = crypto.createHash('sha256').update(signatureString).digest('hex')
return calculatedSignature.toLowerCase() === receivedSignature.toLowerCase()
```

–í test —Ä–µ–∂–∏–º–µ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.  
–í production - **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞**! ‚úÖ

### 4. –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**backend/env.example:**
```bash
# –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
YUKASSA_MODE=test                    # –∏–ª–∏ production
YUKASSA_SECRET_KEY=test_xxx          # –∏–ª–∏ live_xxx

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
# –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å test –∫–ª—é—á –≤ production —Ä–µ–∂–∏–º–µ
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Config System (src/config/index.ts)
  ‚îú‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–µ–π
  ‚îú‚îÄ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ (test/production)
  ‚îî‚îÄ –≠–∫—Å–ø–æ—Ä—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

YooKassa Utils (src/utils/yookassa.ts)
  ‚îú‚îÄ createPayment() - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
  ‚îú‚îÄ getPayment() - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
  ‚îî‚îÄ validateWebhookSignature() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
      ‚îú‚îÄ Test mode: –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
      ‚îî‚îÄ Production mode: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ (SHA-256)

Payments Controller (src/controllers/payments.controller.ts)
  ‚îî‚îÄ webhook() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      ‚îú‚îÄ –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç 200 OK
      ‚îú‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏
      ‚îú‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
      ‚îî‚îÄ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

Subscription Controller (src/controllers/subscription.controller.ts)
  ‚îú‚îÄ createSubscriptionPayment() - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
  ‚îú‚îÄ checkLatestPaymentStatus() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
  ‚îî‚îÄ checkPaymentStatus() - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ**
   - –ù–µ–ª—å–∑—è –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å test –∫–ª—é—á–∞–º–∏ –≤ production
   - –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–µ–π

2. **Webhook –ø–æ–¥–ø–∏—Å—å**
   - –í production –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞
   - SHA-256 —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª—å–Ω—ã—Ö webhook

3. **Environment variables**
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
   - –ß–µ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

4. **CORS**
   - –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
   - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ production

### ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sentry –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫
- [ ] Rate limiting –¥–ª—è API endpoints
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ webhook –≤ –ë–î –¥–ª—è –∞—É–¥–∏—Ç–∞
- [ ] Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è failed webhook

---

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

üìö **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [`docs/PRODUCTION_PAYMENTS_SETUP.md`](docs/PRODUCTION_PAYMENTS_SETUP.md)

–¢–∞–º –µ—Å—Ç—å:
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π YooKassa
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- Troubleshooting
- –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ production

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Test —Ä–µ–∂–∏–º

```bash
# –¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞)
5555 5555 5555 4444
–°—Ä–æ–∫: –ª—é–±–æ–π –±—É–¥—É—â–∏–π
CVC: –ª—é–±–æ–π
```

### Production —Ä–µ–∂–∏–º

‚ö†Ô∏è **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É!**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
1. –°–æ–∑–¥–∞–π—Ç–µ –ø–ª–∞—Ç–µ–∂ –Ω–∞ 79‚ÇΩ (–º–∏–Ω–∏–º—É–º)
2. –û–ø–ª–∞—Ç–∏—Ç–µ —Å–≤–æ–µ–π –∫–∞—Ä—Ç–æ–π
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∫–∏
4. **–°–¥–µ–ª–∞–π—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç** —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç YooKassa

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `vercel logs --follow`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: `vercel env ls`
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é: `docs/PRODUCTION_PAYMENTS_SETUP.md`
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É YooKassa: https://yookassa.ru/developers/support

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 2026-01-28  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready
