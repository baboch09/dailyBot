# Техническое задание: Telegram Mini App - Трекер Привычек

## 1. Общее описание проекта

**Название:** Telegram Mini App - Трекер Привычек  
**Тип:** Production-ready MVP веб-приложение для Telegram  
**Назначение:** Приложение для отслеживания ежедневных привычек с системой подписок и напоминаний

### 1.1. Целевая аудитория
- Пользователи Telegram, желающие формировать и отслеживать полезные привычки
- Пользователи, нуждающиеся в мотивации и визуализации прогресса

### 1.2. Основные возможности
- ✅ Создание и управление привычками
- ✅ Отслеживание выполнения привычек с подсчетом streak (дней подряд)
- ✅ Статистика за последние 7 дней
- ✅ Система подписок (Free и Premium)
- ✅ Интеграция с платежной системой YooKassa
- ✅ Напоминания в Telegram (только для Premium)
- ✅ История платежей и управление подпиской

---

## 2. Архитектура системы

### 2.1. Технологический стек

#### Frontend
- **Framework:** React 18.2.0
- **Language:** TypeScript 5.3.3
- **Build Tool:** Vite 5.0.8
- **Styling:** Tailwind CSS 3.4.0
- **HTTP Client:** Axios 1.6.2
- **Telegram Integration:** Telegram WebApp SDK (через initData)

#### Backend
- **Runtime:** Node.js
- **Framework:** Express 4.18.2
- **Language:** TypeScript 5.3.3
- **ORM:** Prisma 5.7.1
- **Database:** PostgreSQL (production) / SQLite (development)
- **Validation:** express-validator 7.0.1

#### Telegram Bot
- **Library:** node-telegram-bot-api 0.64.0
- **Functionality:** Команды бота, отправка напоминаний

#### Payment Integration
- **Provider:** YooKassa (ЮKassa)
- **Features:** Создание платежей, webhook обработка, проверка статусов

### 2.2. Структура проекта

```
tg/
├── backend/              # Backend API (Express + TypeScript)
│   ├── src/
│   │   ├── controllers/  # Бизнес-логика (habits, payments, subscription)
│   │   ├── middleware/   # Аутентификация, валидация, проверка подписки
│   │   ├── routes/       # API маршруты
│   │   ├── utils/        # Утилиты (streak, yookassa, prisma)
│   │   └── types/        # TypeScript типы
│   ├── prisma/
│   │   └── schema.prisma # Схема базы данных
│   └── package.json
│
├── frontend/             # Frontend приложение (React + Vite)
│   ├── src/
│   │   ├── components/  # React компоненты
│   │   │   ├── HabitItem.tsx
│   │   │   ├── AddHabitForm.tsx
│   │   │   ├── SubscriptionManager.tsx
│   │   │   ├── SubscriptionPlans.tsx
│   │   │   └── SubscriptionStatus.tsx
│   │   ├── services/     # API клиент
│   │   ├── types/        # TypeScript типы
│   │   ├── utils/        # Утилиты (telegram)
│   │   └── App.tsx       # Главный компонент
│   └── package.json
│
├── bot/                  # Telegram Bot
│   ├── src/
│   │   └── index.ts      # Логика бота
│   └── package.json
│
├── api/                  # Vercel Serverless Functions
│   ├── bot.ts
│   ├── health.ts
│   ├── index.ts
│   └── reminders.ts
│
└── package.json          # Корневой package.json
```

### 2.3. Деплой
- **Frontend:** Vercel (автоматический деплой через GitHub)
- **Backend:** Vercel Serverless Functions
- **Database:** PostgreSQL (Vercel Postgres / Supabase)
- **Bot:** Отдельный сервер или Vercel Serverless Function

---

## 3. Модели данных (Prisma Schema)

### 3.1. User (Пользователь)
```prisma
model User {
  id         String   @id @default(cuid())
  telegramId BigInt   @unique              // Уникальный ID из Telegram
  timezone   String   @default("UTC+3")    // Часовой пояс
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Подписка
  subscriptionType     String?  @default("free")    // "free" | "premium" | "trial"
  subscriptionStatus   String?  @default("active")   // "active" | "expired" | "canceled"
  subscriptionExpiresAt DateTime?                    // Дата окончания подписки
  subscriptionStartedAt DateTime?                    // Дата начала подписки

  habits   Habit[]
  payments Payment[]
}
```

### 3.2. Habit (Привычка)
```prisma
model Habit {
  id            String   @id @default(cuid())
  userId        String
  name          String                    // Название привычки
  description   String?                   // Описание (опционально)
  reminderTime  String?                   // Время напоминания "HH:MM" (только Premium)
  reminderEnabled Boolean @default(true)   // Включено ли напоминание
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs HabitLog[]

  @@index([userId])
}
```

### 3.3. HabitLog (Лог выполнения)
```prisma
model HabitLog {
  id        String   @id @default(cuid())
  habitId   String
  date      DateTime @default(now())      // Дата выполнения (только день)
  createdAt DateTime @default(now())

  habit Habit @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])  // Одна отметка на привычку в день
  @@index([habitId])
  @@index([date])
}
```

### 3.4. Payment (Платеж)
```prisma
model Payment {
  id            String   @id @default(cuid())
  userId        String
  yookassaId    String?  @unique         // ID платежа в YooKassa
  amount        Float                     // Сумма в рублях
  currency      String   @default("RUB")
  status        String   @default("pending")  // "pending" | "succeeded" | "canceled" | "failed"
  paymentMethod String?                    // Способ оплаты
  description   String?                   // Описание платежа
  metadata      String?                   // Дополнительные данные (JSON)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([yookassaId])
  @@index([status])
}
```

---

## 4. Функциональность

### 4.1. Аутентификация

**Метод:** Аутентификация через Telegram ID  
**Механизм:**
- Frontend извлекает `telegram_id` из `initData` Telegram WebApp
- `telegram_id` передается в заголовке `x-telegram-id` при каждом запросе
- Backend middleware проверяет наличие и валидность `telegram_id`
- Пользователь автоматически создается при первом обращении

**Особенности:**
- Без регистрации - пользователь идентифицируется только по Telegram ID
- Автоматическое создание пользователя при первом использовании
- Валидация формата Telegram ID (BigInt)

### 4.2. Управление привычками

#### 4.2.1. Создание привычки
- **Endpoint:** `POST /api/habits`
- **Параметры:**
  - `name` (обязательно) - название привычки
  - `description` (опционально) - описание
  - `reminderTime` (опционально, только Premium) - время напоминания "HH:MM"
  - `reminderEnabled` (опционально, только Premium) - включить/выключить напоминание
- **Ограничения:**
  - Free план: максимум 3 привычки
  - Premium план: безлимит привычек
  - Напоминания доступны только для Premium
- **Валидация:**
  - Название не может быть пустым
  - Проверка лимита привычек перед созданием
  - Атомарная проверка через транзакцию (предотвращение race condition)

#### 4.2.2. Получение списка привычек
- **Endpoint:** `GET /api/habits`
- **Возвращает:**
  - Список всех привычек пользователя
  - Для каждой привычки: streak, статус выполнения за сегодня, описание

#### 4.2.3. Обновление привычки
- **Endpoint:** `PUT /api/habits/:id`
- **Параметры:** те же, что и при создании
- **Ограничения:** только владелец может обновлять

#### 4.2.4. Удаление привычки
- **Endpoint:** `DELETE /api/habits/:id`
- **Каскадное удаление:** все логи привычки удаляются автоматически

#### 4.2.5. Отметка выполнения
- **Endpoint:** `POST /api/habits/:id/complete`
- **Функционал:**
  - Переключение статуса выполнения за текущий день
  - Автоматический пересчет streak (дней подряд)
  - Если привычка уже выполнена - снимает отметку и сбрасывает streak
  - Если не выполнена - ставит отметку и обновляет streak
- **Возвращает:** обновленный статус и новый streak

#### 4.2.6. Статистика привычки
- **Endpoint:** `GET /api/habits/:id/stats`
- **Возвращает:**
  - Статистику за последние 7 дней
  - Текущий streak
  - Массив логов с датами выполнения

### 4.3. Подсчет Streak (дней подряд)

**Алгоритм:**
- Streak считается как количество дней подряд, когда привычка была выполнена
- Начинается с самой последней отметки и идет назад по датам
- Прерывается, если найден день без отметки
- Учитывается только один раз в день (уникальность по `[habitId, date]`)

**Особенности:**
- Автоматический пересчет при каждой отметке
- Учитывается часовой пояс пользователя
- В тестовом режиме: каждые 5 минут = новый "день" (для тестирования)

### 4.4. Система подписок

#### 4.4.1. Тарифные планы

**Free план:**
- Максимум 3 привычки
- Без напоминаний
- Базовые функции трекинга

**Premium план:**
- Безлимит привычек
- Напоминания в Telegram
- Все функции доступны

#### 4.4.2. Тарифы и цены

**Месячная подписка:**
- Цена: **79 ₽**
- Длительность: 30 дней

**Годовая подписка:**
- Цена: **799 ₽** (экономия 149 ₽ по сравнению с месячной)
- Длительность: 365 дней
- Отображение: зачеркнутая цена 948 ₽ (79 × 12) и актуальная 799 ₽

#### 4.4.3. Управление подпиской

**Получение статуса подписки:**
- **Endpoint:** `GET /api/subscription/status`
- **Возвращает:**
  - Тип подписки (free/premium)
  - Статус (active/expired/canceled)
  - Даты начала и окончания
  - Количество дней до окончания
  - История последних 10 платежей с пометкой активного платежа

**Получение тарифов:**
- **Endpoint:** `GET /api/subscription/plans`
- **Возвращает:** список доступных тарифов с ценами

**Логика определения активной подписки:**
- Подписка активна, если `subscriptionStatus === 'active'` и `subscriptionExpiresAt > now`
- Автоматическое обновление статуса на `expired` при истечении
- Не устанавливается `expired`, если есть pending платеж (обработка оплаты)

### 4.5. Система платежей (YooKassa)

#### 4.5.1. Создание платежа
- **Endpoint:** `POST /api/subscription/create-payment`
- **Параметры:** `planId` ("month" | "year")
- **Процесс:**
  1. Проверка наличия активного pending платежа
  2. Создание платежа в YooKassa через API
  3. Сохранение платежа в БД со статусом "pending"
  4. Возврат `confirmationUrl` для редиректа пользователя
- **Возвращает:** paymentId, yookassaId, amount, confirmationUrl, status

#### 4.5.2. Обработка webhook от YooKassa
- **Endpoint:** `POST /api/payments/webhook`
- **События:** `payment.succeeded`, `payment.canceled`
- **Процесс:**
  1. Быстрый ответ 200 OK (требование YooKassa)
  2. Валидация подписи webhook (в production)
  3. Получение актуального статуса из YooKassa API
  4. Обновление статуса платежа в БД
  5. При успешном платеже - автоматическая активация подписки
- **Безопасность:** Проверка подписи webhook в production режиме

#### 4.5.3. Проверка статуса платежа
- **Endpoint:** `GET /api/subscription/payment/:paymentId/status`
- **Функционал:** Проверка статуса конкретного платежа в YooKassa и обновление в БД

#### 4.5.4. Проверка последнего платежа (после редиректа)
- **Endpoint:** `GET /api/subscription/check-latest-payment`
- **Назначение:** Проверка статуса последнего платежа после возврата с YooKassa
- **Процесс:**
  1. Находит последний платеж пользователя
  2. Проверяет статус в YooKassa API
  3. Обновляет статус в БД
  4. Активирует подписку при успешном платеже
- **Использование:** Вызывается автоматически после редиректа с `?payment=success`

#### 4.5.5. Обработка возврата после оплаты

**Frontend логика:**
1. При возврате с `?payment=success`:
   - Удаление параметра из URL
   - Проверка статуса последнего платежа через API
   - Если платеж успешен - обновление статуса подписки и перезагрузка страницы
   - Если pending - повторная проверка через 2 секунды
   - Показ уведомлений пользователю

2. При возврате с `?payment=fail`:
   - Показ сообщения об ошибке

**Backend логика:**
- Webhook обрабатывает платеж асинхронно
- Проверка статуса при возврате гарантирует активацию подписки даже если webhook задержался

### 4.6. История платежей

**Отображение:**
- Список последних 10 платежей пользователя
- Для каждого платежа:
  - Сумма и дата создания
  - Статус с цветовой индикацией:
    - **"Активна"** (синий) - текущая активная подписка
    - **"Оплачено"** (зеленый) - прошлые успешные платежи
    - **"Ожидание"** (желтый) - pending платежи
    - **"Ошибка"** (красный) - failed/canceled платежи
- Визуальное выделение активной подписки (синий фон, точка)

**Определение активного платежа:**
- Если подписка активна, последний успешный платеж помечается как `isActive: true`
- Отображается с особым стилем и статусом "Активна"

### 4.7. Напоминания (Premium функция)

**Функционал:**
- Настройка времени напоминания для каждой привычки (формат "HH:MM")
- Включение/выключение напоминаний
- Отправка напоминаний через Telegram Bot
- Учет часового пояса пользователя

**Ограничения:**
- Только для Premium подписчиков
- При создании привычки с напоминанием на Free плане - автоматическое отключение

**Реализация:**
- Endpoint для отправки напоминаний: `/api/reminders`
- Serverless функция для cron-задач (Vercel Cron)
- Интеграция с Telegram Bot API

### 4.8. Telegram Bot

**Команды:**
- `/start` - приветствие и кнопка для открытия Mini App

**Функционал:**
- Отправка напоминаний пользователям
- Кнопка для быстрого открытия Mini App
- Обработка callback queries

---

## 5. API Endpoints

### 5.1. Привычки

| Метод | Endpoint | Описание | Аутентификация |
|-------|----------|----------|----------------|
| GET | `/api/habits` | Получить все привычки | ✅ |
| POST | `/api/habits` | Создать привычку | ✅ |
| PUT | `/api/habits/:id` | Обновить привычку | ✅ |
| DELETE | `/api/habits/:id` | Удалить привычку | ✅ |
| POST | `/api/habits/:id/complete` | Отметить выполнение | ✅ |
| GET | `/api/habits/:id/stats` | Статистика за 7 дней | ✅ |

### 5.2. Подписка

| Метод | Endpoint | Описание | Аутентификация |
|-------|----------|----------|----------------|
| GET | `/api/subscription/status` | Статус подписки | ✅ |
| GET | `/api/subscription/plans` | Список тарифов | ✅ |
| POST | `/api/subscription/create-payment` | Создать платеж | ✅ |
| GET | `/api/subscription/payment/:paymentId/status` | Статус платежа | ✅ |
| GET | `/api/subscription/check-latest-payment` | Проверить последний платеж | ✅ |

### 5.3. Платежи (Webhook)

| Метод | Endpoint | Описание | Аутентификация |
|-------|----------|----------|----------------|
| POST | `/api/payments/webhook` | Webhook от YooKassa | ❌ (подпись) |

### 5.4. Health Check

| Метод | Endpoint | Описание | Аутентификация |
|-------|----------|----------|----------------|
| GET | `/api/health` | Проверка работоспособности | ❌ |

---

## 6. UI/UX особенности

### 6.1. Дизайн
- **Стиль:** Минималистичный, современный интерфейс
- **Адаптивность:** Полностью адаптивный дизайн для мобильных устройств
- **Тема:** Поддержка светлой и темной темы (через Telegram themeParams)
- **Анимации:** Плавные переходы и анимации для улучшения UX

### 6.2. Компоненты интерфейса

**Главный экран:**
- Заголовок с иконкой и названием приложения
- Счетчик привычек (текущее количество / лимит)
- Менеджер подписки с карточкой статуса
- Форма добавления новой привычки
- Список привычек с возможностью отметки выполнения

**Карточка привычки:**
- Название и описание
- Streak (дни подряд) с визуальной индикацией
- Чекбокс для отметки выполнения за сегодня
- Кнопки редактирования и удаления
- Статистика за последние 7 дней (визуализация)

**Менеджер подписки:**
- Карточка статуса (Free/Premium) с визуальным различием
- Кнопка "Обновить" для перехода на Premium
- Выпадающий список тарифов
- История платежей с детальной информацией

**Экран тарифов:**
- Табы "Месяц" / "Год"
- Для годового тарифа: зачеркнутая цена и актуальная цена
- Расчет экономии и стоимости в месяц
- Список преимуществ Premium
- Кнопка оформления подписки

### 6.3. Обработка ошибок
- Понятные сообщения об ошибках на русском языке
- Визуальная индикация ошибок (красные блоки)
- Автоматическая обработка ошибок аутентификации
- Информативные сообщения при ограничениях Free плана

### 6.4. Обратная связь пользователю
- Уведомления об успешных операциях
- Сообщения о статусе платежей
- Индикация загрузки при API запросах
- Автоматическое обновление данных после операций

---

## 7. Безопасность

### 7.1. Аутентификация
- Проверка наличия Telegram ID в заголовках
- Валидация формата Telegram ID
- Автоматическое создание пользователя при первом обращении

### 7.2. Авторизация
- Проверка владения ресурсами (привычки принадлежат пользователю)
- Middleware для проверки подписки при доступе к Premium функциям
- Защита от race condition при создании привычек (транзакции)

### 7.3. Платежи
- Валидация подписи webhook от YooKassa (в production)
- Проверка статуса платежа через YooKassa API перед активацией подписки
- Защита от дублирования активации подписки

### 7.4. Валидация данных
- Валидация входных данных через express-validator
- Проверка лимитов перед созданием ресурсов
- Санитизация пользовательского ввода

---

## 8. Производительность и оптимизация

### 8.1. База данных
- Индексы на часто используемых полях (userId, yookassaId, status, date)
- Уникальные ограничения для предотвращения дубликатов
- Каскадное удаление связанных данных

### 8.2. API
- Оптимизированные запросы с необходимыми полями
- Транзакции для атомарных операций
- Эффективная обработка webhook (быстрый ответ, асинхронная обработка)

### 8.3. Frontend
- Ленивая загрузка компонентов
- Оптимистичные обновления UI
- Кэширование данных где возможно

---

## 9. Интеграции

### 9.1. Telegram
- **Telegram WebApp SDK:** Для получения initData и telegram_id
- **Telegram Bot API:** Для отправки напоминаний и команд бота
- **Telegram Mini App:** Основной интерфейс приложения

### 9.2. YooKassa
- **API для создания платежей:** Создание платежных сессий
- **Webhook для уведомлений:** Асинхронная обработка статусов платежей
- **API для проверки статуса:** Синхронная проверка статуса платежа

### 9.3. Vercel
- **Serverless Functions:** Backend API endpoints
- **Cron Jobs:** Для отправки напоминаний
- **Automatic Deployments:** CI/CD через GitHub

---

## 10. Ограничения и лимиты

### 10.1. Free план
- Максимум 3 привычки
- Без напоминаний
- Базовые функции трекинга

### 10.2. Premium план
- Безлимит привычек
- Напоминания в Telegram
- Все функции доступны

### 10.3. Технические ограничения
- Одна отметка выполнения на привычку в день
- История платежей: последние 10 записей
- Статистика: последние 7 дней

---

## 11. Тестирование

### 11.1. Тестовый режим
- **Streak расчет:** В тестовом режиме каждые 5 минут = новый "день"
- **YooKassa:** Тестовый режим с тестовыми картами
- **Webhook:** Пропуск проверки подписи в тестовом режиме

### 11.2. Тестовые данные
- Тестовая карта YooKassa: `5555 5555 5555 4444`
- Тестовый режим включается через переменную окружения

---

## 12. Деплой и окружения

### 12.1. Переменные окружения

**Backend:**
- `DATABASE_URL` - URL базы данных PostgreSQL
- `YUKASSA_SHOP_ID` - ID магазина в YooKassa
- `YUKASSA_SECRET_KEY` - Секретный ключ YooKassa
- `YUKASSA_TEST_MODE` - Режим тестирования (true/false)
- `WEBAPP_URL` - URL фронтенда для редиректов
- `FRONTEND_URL` - Альтернативный URL фронтенда

**Frontend:**
- `VITE_API_URL` - URL backend API (опционально, определяется автоматически)

**Bot:**
- `TELEGRAM_BOT_TOKEN` - Токен Telegram бота
- `WEBAPP_URL` - URL Mini App

### 12.2. Процесс деплоя
1. Push в GitHub репозиторий
2. Автоматический деплой на Vercel
3. Применение миграций базы данных
4. Обновление webhook URL в YooKassa
5. Обновление WebApp URL в BotFather

---

## 13. Мониторинг и логирование

### 13.1. Логирование
- Логи всех API запросов
- Логи обработки платежей
- Логи ошибок с деталями
- Логи webhook событий

### 13.2. Мониторинг
- Health check endpoint
- Отслеживание ошибок платежей
- Мониторинг статусов подписок

---

## 14. Будущие улучшения

### 14.1. Планируемые функции
- [ ] Экспорт статистики
- [ ] Социальные функции (делиться прогрессом)
- [ ] Геймификация (достижения, бейджи)
- [ ] Кастомные категории привычек
- [ ] Графики и аналитика
- [ ] Напоминания через push-уведомления

### 14.2. Технические улучшения
- [ ] Удаление тестового режима для streak
- [ ] Полная реализация проверки подписи webhook
- [ ] Оптимизация запросов к базе данных
- [ ] Добавление unit и integration тестов
- [ ] Улучшение обработки ошибок

---

## 15. Заключение

Проект представляет собой полнофункциональное production-ready приложение для трекинга привычек в Telegram с системой подписок и интеграцией платежей. Приложение использует современный технологический стек, следует best practices и готово к масштабированию.

**Основные достижения:**
- ✅ Полная интеграция с Telegram Mini App
- ✅ Система подписок с двумя тарифами
- ✅ Интеграция с платежной системой YooKassa
- ✅ Напоминания для Premium пользователей
- ✅ Удобный и интуитивный интерфейс
- ✅ Надежная обработка платежей и активация подписок
- ✅ Production-ready код с обработкой ошибок

---

**Версия документа:** 1.0  
**Дата создания:** 2026-01-25  
**Последнее обновление:** 2026-01-25
